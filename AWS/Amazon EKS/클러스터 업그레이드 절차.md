# 클러스터 업그레이드 

1. efs-csi-controller
   1. 기존 helm 차트로 관리되던 것은 관리형 애드온으로 변경
   2. 현재 정보
      1. IAM 역할 
         1. arn:aws:iam::854013278161:role/eksctl-mega-message-dev-addon-iamserviceacco-Role1-1BV9EQCD0MLI5
      2. StorageClass 이름: 
         1. aws-efs-storage
      3. Service Account Name: 
         1. efs-csi-controller-sa
      4. 현재 설치된 Helm 차트 정보 확인
         1. helm list -n kube-system --context arn:aws:eks:ap-northeast-2:854013278161:cluster/mega-message-dev
      5. 현재 실행 중인 컨트롤러 Deployment 확인
         1. kubectl get deployment efs-csi-controller -n kube-system --context arn:aws:eks:ap-northeast-2:854013278161:cluster/mega-message-dev
         2. efs-csi-controller   2/2     2
      6. 현재 각 노드에서 실행 중인 드라이버 DaemonSet 확인
         1. kubectl get daemonset efs-csi-node -n kube-system --context arn:aws:eks:ap-northeast-2:854013278161:cluster/mega-message-dev
         2. efs-csi-node   9         9         9       9            9           kubernetes.io/os=linux그러면 
   3. 프로세스
      1. 기존 Helm 차트 삭제
         1.  Helm이 관리하던 efs-csi-controller Deployment와 efs-csi-node DaemonSet을 포함한 모든 관련 리소스를 삭제하도록 지시
         2.  helm uninstall aws-efs-csi-driver -n kube-system --kube-context arn:aws:eks:ap-northeast-2:854013278161:cluster/mega-message-dev
      2. 관리형 애드온 설치
         1.  Helm 차트가 삭제되자마자, EKS에게 동일한 기능의 관리형 애드온을 설치하라고 지시
         2.  --service-account-role-arn: 1단계에서 확인한 IAM 역할을 애드온에 연결하여 EFS에 접근할 권한을 부여
         3.  --resolve-conflicts PRESERVE: (매우 중요) EKS에게 "애드온을 설치하다가 기존에 있던 리소스(예: aws-efs-storage StorageClass)와 이름이 충돌하면, 애드온의 기본 설정으로 덮어쓰지 말고 기존 것을 그대로 유지해라"라고 지시하는 안전장치
         4.  aws eks create-addon --cluster-name mega-message-dev --addon-name aws-efs-csi-driver --service-account-role-arn "arn:aws:iam::854013278161:role/eksctl-mega-message-dev-addon-iamserviceacco-Role1-1BV9EQCD0MLI5" --resolve-conflicts PRESERVE --profile megadev
      3. 결과 확인
         1. 애드온 상태 확인
            1. 애드온이 ACTIVE 상태가 되었는지, 혹시 다른 문제는 없는지 확인
            2. aws eks describe-addon --cluster-name mega-message-dev --addon-name aws-efs-csi-driver --profile megadev
         2. Pod 상태 확인
            1. EKS 관리형 애드온이 새로 생성한 efs-csi-controller와 efs-csi-node Pod들이 정상적으로 Running 상태인지 확인
            2. kubectl get deployment -n kube-system -l app.kubernetes.io/name=aws-efs-csi-driver --context arn:aws:eks:ap-northeast-2:854013278161:cluster/mega-message-dev
            3. kubectl get daemonset -n kube-system -l app.kubernetes.io/name=aws-efs-csi-driver --context arn:aws:eks:ap-northeast-2:854013278161:cluster/mega-message-dev
2. 노드 그룹 
   1. AMI 버전 업데이트
   2. 프로세스 
      1. 기존 노드 그룹과 동일한 노드 그룹 생성
      2. 새로운 노드 확인
         1. kubectl get nodes
      3. 기존 노드 그룹의 노드들 cordon
      4. api 서버
         1. rollout 그린 배포
         2. promote full 전환
      5. 나머지
         1. 
            