# Amazon EC2

## EC2 생성
- 이름 태그 추가할 때, 리소스 유형에 볼륨도 선택해주기
- ec2 스토리지 구성 > 고급 > 종료시 삭제 : 예 
  - ec2 삭제시 같이 삭제되도록
- 중지하고 재시작하면 public ip는 재설정됨.


## SSH 연결
```sh
# pem 키 권한 파일을 읽을 수 있는 권한을 소유자만 가지게 설정
chmod 400 ./megabird-local-ec2.pem

# ssh 연결
ssh -i ./megabird-local-ec2.pem ec2-user@15.165.253.184

# private 인스턴스 연결
bastion 서버에 먼저 ssh로 붙는다.
bastion 서버에 pem 키를 업로드 
ssh로 private 인스턴스 private IP로 연결

# private 인스턴스가 인터넷과 연결되는지 확인
curl -v www.naver.com
```

## 보안그룹 (Security Group)
- 인스턴스 수준에 적용됨.
- In/OutBound에 White List 방식으로 적용 가능
- **상태저장(statefull)**
  - 들어온 요청 트래픽에 대해 자동으로 응답 트래픽을 허용하는 방식
  - 인바운드 트래픽이 허용되면 아웃바운드 응답 트래픽은 별도의 설정 없이 허용
- 모든 규칙 평가 적용
  - 더 큰 IP 대역이 우선 적용됨.
- 연결된 경우에만 적용
  - 인스턴스와 연결이 되어야 함

1. 보안그룹을 소스로 지정하는 이유

2) 동적 IP 할당 문제

	-	EC2 인스턴스의 IP 주소는 변경될 수 있습니다. 특히 인스턴스를 중지했다가 다시 시작하면 퍼블릭 IP 주소가 바뀔 수 있고, 프라이빗 IP도 VPC의 설정에 따라 변경될 수 있습니다.
	-	만약 특정 IP 주소를 소스로 지정한다면, 인스턴스가 재시작되면서 IP 주소가 변경될 경우, 다시 설정을 업데이트해야 하는 번거로움이 생깁니다.
	-	하지만 보안그룹을 소스로 지정하면 인스턴스의 IP 주소가 변경되어도 걱정할 필요가 없습니다. 보안그룹 자체는 EC2 인스턴스와의 관계가 지속되므로, Bastion 서버가 어떤 IP를 가지고 있든 상관없이 규칙이 계속 적용됩니다.

3) 유연한 접근 제어

	-	보안그룹을 소스로 설정하면 **여러 인스턴스가 동일한 보안그룹에 속한 경우, 해당 보안그룹에 속한 모든 인스턴스에서 Private EC2로의 접근이 가능**하게 됩니다.
	-	Bastion 서버가 여러 대 있거나 자동 확장(autoscaling)을 사용하는 경우, 인스턴스마다 IP를 일일이 관리할 필요 없이 해당 인스턴스들이 속한 보안그룹만 지정하면 됩니다. 이렇게 하면 관리가 훨씬 간편해지고, Bastion 서버가 추가되거나 제거될 때도 별도의 규칙 수정이 필요 없습니다.

4) 보안그룹 간의 허용

	-	AWS에서는 보안그룹 간의 트래픽을 허용할 수 있습니다. 즉, **인바운드 규칙에서 소스로 보안그룹을 지정하면, 그 보안그룹에 속한 인스턴스들 간에는 자동으로 트래픽이 허용**됩니다.
	-	예를 들어, Bastion 서버가 속한 보안그룹을 Private EC2 인스턴스의 인바운드 규칙 소스로 지정하면, Bastion 서버가 어떤 IP 주소를 갖고 있든 해당 보안그룹에 속해 있는 한, Private 인스턴스에 접근할 수 있습니다.

5. Bastion 서버 자체를 소스로 설정하지 않는 이유

Bastion 서버의 IP 주소나 호스트를 소스로 지정하는 방식은 불편하고 위험할 수 있습니다:

-	고정되지 않은 IP 주소: 퍼블릭 IP 주소는 동적일 수 있습니다. Bastion 서버의 퍼블릭 IP가 바뀌면 설정을 다시 수정해야 합니다.
-	관리의 어려움: 여러 대의 Bastion 서버를 사용하거나 Bastion 서버를 확장할 때는 새로운 서버마다 IP를 추가로 설정해야 하는데, 이는 관리의 번거로움을 초래합니다.
-	가시성 문제: 보안그룹 간의 트래픽 규칙은 AWS 콘솔에서 쉽게 가시성을 확보할 수 있으며, 어떤 인스턴스가 어떤 규칙을 따르고 있는지 한눈에 파악하기 쉽습니다.

3. 보안그룹을 사용한 예시

예를 들어, 다음과 같이 보안 그룹을 구성할 수 있습니다:

1.	Bastion 서버 보안 그룹 (sg-bastion): 이 보안그룹에는 SSH(22) 포트에 대해 외부(0.0.0.0/0)에서 들어오는 인바운드를 허용합니다.
-	소스: 0.0.0.0/0
-	포트: 22 (SSH)
2.	Private EC2 인스턴스 보안 그룹 (sg-private): 이 보안그룹에서는 SSH 포트에 대해 **Bastion 서버 보안 그룹(sg-bastion)**을 소스로 지정합니다.
-	소스: sg-bastion
-	포트: 22 (SSH)

이렇게 하면, Bastion 서버의 보안그룹에 속한 인스턴스들만 Private EC2 인스턴스에 접근할 수 있게 설정됩니다.


## 로드밸런서
Elastic Load Balancing(ELB)

1. Application Load Balancer (ALB):

-	**7계층(애플리케이션 계층)**에서 동작하는 로드 밸런서.
-	HTTP/HTTPS 트래픽을 처리하며, URL 경로 또는 호스트 이름에 따라 트래픽을 다른 서비스나 인스턴스로 분배할 수 있습니다.
-	특징:
-	URL 경로 기반 라우팅: 예를 들어, /images로 들어오는 요청은 이미지 처리 서버로 보내고, /api로 들어오는 요청은 API 서버로 보낼 수 있음.
-	웹소켓 지원.
-	SSL 종료 가능: SSL 인증서를 로드 밸런서에 적용하고, 인스턴스와의 통신은 암호화하지 않는 방식으로 통신 성능 최적화.
-	서버 상태 확인(Health Check)을 통해 비정상적인 서버로 트래픽을 보내지 않음.
-	대상 그룹(Target Group): 특정 조건에 맞는 대상 그룹에 트래픽을 전달.

2. Network Load Balancer (NLB):

-	**4계층(전송 계층)**에서 동작하는 로드 밸런서.
-	TCP/UDP 트래픽을 처리하며, 매우 높은 처리량을 필요로 하는 애플리케이션이나 매우 낮은 지연 시간(Latency)을 요구하는 서비스에 적합.
-	특징:
-	TCP/UDP 기반의 트래픽을 처리하며 초당 수백만 건의 요청을 처리할 수 있음.
-	고정 IP 지원: NLB는 각 가용 영역에 고정된 IP 주소를 가질 수 있어, 클라이언트가 특정 IP로 쉽게 접근할 수 있음.
-	프록시 프로토콜 지원: NLB는 소스 IP 주소와 포트를 유지하여 전달할 수 있어 클라이언트의 실제 IP를 서버에서 확인 가능.
-	비정상적인 대상에 대해 트래픽을 자동으로 차단.

3. Gateway Load Balancer (GWLB):

-	네트워크 서비스 트래픽을 처리하는 로드 밸런서.
-	네트워크 트래픽을 보안 어플라이언스(예: 방화벽, 침입 방지 시스템)로 보내서 처리하도록 설계됨.
-	특징:
-	제3자 보안 어플라이언스와의 통합을 용이하게 함.
-	단일 진입점으로 트래픽을 통제하고 라우팅할 수 있음.
-	상태 비저장(State-less) 트래픽을 처리하며, 높은 가용성과 확장성을 제공.

로드 밸런서의 주요 기능

-	트래픽 분산: 여러 인스턴스나 서비스로 트래픽을 분산하여 서버의 부하를 줄임으로써 애플리케이션의 성능과 가용성을 향상시킴.
-	헬스 체크(Health Check): 로드 밸런서는 주기적으로 대상의 상태를 확인하여 비정상적인 대상에는 트래픽을 보내지 않음.
-	자동 확장: AWS Auto Scaling과 연동하여, 트래픽 양에 따라 인스턴스 수를 자동으로 늘리거나 줄일 수 있음.
-	HTTPS/SSL 지원: 로드 밸런서에서 HTTPS 트래픽을 처리하며 SSL 인증서를 적용해 보안을 강화할 수 있음.
-	대상 그룹: 트래픽을 분배할 대상을 그룹으로 묶어 특정 조건에 따라 트래픽을 보낼 수 있음.

로드 밸런서를 사용하는 이유

-	고가용성: 여러 인스턴스나 가용 영역에 트래픽을 분산하여 특정 인스턴스나 영역에 장애가 발생하더라도 서비스가 지속 가능.
-	확장성: 애플리케이션의 트래픽 증가에 따라 쉽게 확장 가능.
-	성능 최적화: 클라이언트의 요청을 최적의 서버로 라우팅하여 응답 시간을 단축.
-	보안 강화: SSL 종료, 웹 애플리케이션 방화벽(WAF) 통합 등을 통해 보안 위협을 방지.

로드 밸런서 선택 가이드

-	HTTP/HTTPS 트래픽이나 애플리케이션 계층의 기능이 필요한 경우: **Application Load Balancer (ALB)**가 적합.
-	TCP/UDP 트래픽을 다루거나 고속 네트워크 통신이 필요한 경우: **Network Load Balancer (NLB)**가 적합.
-	네트워크 보안 트래픽을 처리할 경우: **Gateway Load Balancer (GWLB)**를 사용.

2. 가용 영역 선택의 의미

로드 밸런서를 생성할 때 가용 영역을 선택하면, 그 가용 영역 내의 인스턴스나 대상들에 트래픽을 분산하게 됩니다. 
선택된 가용 영역에서 ELB는 로드 밸런서를 위한 서브넷을 사용하며, 이 서브넷 내에서 트래픽을 분산할 수 있게 됩니다.

### 리스너(Listener)

리스너는 ELB가 클라이언트로부터 트래픽을 수신하는 프로세스를 정의하는 구성 요소입니다. 
리스너는 프로토콜과 포트 번호로 구성되며, ELB는 이 리스너에 정의된 설정에 따라 들어오는 트래픽을 받아들입니다.

리스너의 주요 요소:

-	**프로토콜**: HTTP, HTTPS, TCP, TLS 등. 리스너가 트래픽을 수신할 때 사용할 프로토콜을 지정합니다.
-	**포트 번호**: ELB가 **클라이언트 요청을 수신할 때 사용할 포트 번호**입니다. 예를 들어, HTTP 요청은 80번 포트에서, HTTPS 요청은 443번 포트에서 수신하는 것이 일반적입니다.
-	SSL 인증서(HTTPS의 경우): HTTPS를 사용하는 리스너는 SSL/TLS 암호화 통신을 위해 인증서를 요구합니다. 이를 통해 클라이언트와 서버 간에 안전하게 통신할 수 있습니다.

예시:

	-	HTTP 트래픽을 80번 포트에서 수신하려면 리스너는 프로토콜: HTTP, 포트: 80으로 설정합니다.
	-	HTTPS 트래픽을 443번 포트에서 수신하려면 프로토콜: HTTPS, 포트: 443으로 설정하고, SSL 인증서를 추가해야 합니다.

### 라우팅 설정

리스너가 트래픽을 수신한 후, ELB는 이 트래픽을 **적절한 대상으로 라우팅**합니다. 
라우팅 설정은 **대상 그룹(Target Group)** 에 따라 결정되며, 리스너에 정의된 규칙에 따라 트래픽이 적절한 대상 그룹으로 전달됩니다.

라우팅의 주요 개념:

- 대상 그룹(Target Group): 트래픽이 전달될 대상들을 정의한 그룹입니다. 대상 그룹은 EC2 인스턴스, IP 주소, Lambda 함수 등을 포함할 수 있습니다. ELB는 트래픽을 대상 그룹에 전달하고, 해당 그룹 내의 대상에게 트래픽을 분산합니다.
- 라우팅 규칙: 리스너는 라우팅 규칙을 기반으로 트래픽을 분배합니다. 라우팅 규칙은 요청의 특정 조건에 따라 트래픽을 어떻게 처리할지 결정합니다.
  - 호스트 기반 라우팅(Host-based Routing): HTTP/HTTPS 요청의 **호스트 헤더(예: www.example.com)에 따라** 트래픽을 특정 대상 그룹으로 전달합니다.
  - 경로 기반 라우팅(Path-based Routing): HTTP/HTTPS **요청의 경로(예: /api, /images)에 따라** 트래픽을 특정 대상 그룹으로 전달합니다.
  - 고정 응답(Static Response): ELB가 **특정 요청에 대해 직접 고정된 응답을 보내도록** 설정할 수도 있습니다. 예를 들어, 서버가 아닌 **로드 밸런서에서 404 응답**을 보내는 경우입니다.
  - 리다이렉션(Redirection): **특정 요청을 다른 URL로 리디렉션**할 수 있습니다. 예를 들어, http://example.com 요청을 https://example.com으로 리디렉션하는 설정이 가능합니다.

예시:

	-	/api/* 경로로 들어오는 모든 요청을 API 서버로 보내고, /images/* 경로로 들어오는 요청은 이미지 서버로 라우팅할 수 있습니다.
	-	www.example.com으로 오는 요청은 웹 서버 그룹으로, api.example.com으로 오는 요청은 API 서버 그룹으로 라우팅할 수 있습니다.

### 리스너 규칙(Listener Rules)

리스너는 규칙(Rules)을 통해 트래픽이 어떻게 처리될지 세부적으로 정의할 수 있습니다. 
규칙은 우선순위에 따라 처리되며, 각 규칙은 **조건(Conditions)**과 **작업(Actions)**으로 구성됩니다.

- 조건(Conditions): 요청의 특정 조건을 기반으로 트래픽을 분배합니다. 조건에는 호스트 헤더, 경로, HTTP 헤더, 쿠키 등이 포함될 수 있습니다.
  - 예: Host가 www.example.com이면 웹 애플리케이션 대상 그룹으로 라우팅.
-		예: 경로가 /api/*이면 API 서버 대상 그룹으로 라우팅.
-	작업(Actions): 조건이 충족되면 수행할 작업을 정의합니다. 일반적으로 트래픽을 특정 대상 그룹으로 전달하는 작업이지만, 고정 응답을 보내거나 리디렉션을 수행할 수도 있습니다.
-		예: 경로가 /images/*이면, 이미지 서버 대상 그룹으로 라우팅.
-		예: 요청을 HTTPS로 리다이렉트.

리스너 규칙은 우선순위가 높을수록 먼저 평가됩니다. 각 요청은 처음 일치하는 규칙을 찾아 그 규칙에 따라 처리됩니다.

## 대상 그룹(Target Group) 및 헬스 체크(Health Check)

리스너가 트래픽을 수신하면 해당 트래픽을 대상 그룹에 전달합니다. 대상 그룹은 하나 이상의 **대상(EC2 인스턴스, Lambda 등)**을 포함하며, 로드 밸런서는 대상 그룹 내의 대상들에게 트래픽을 분산합니다.

-	헬스 체크(Health Check): 대상 그룹 내의 대상을 정기적으로 검사하여 정상 상태인지 확인합니다. 비정상적인 대상에는 트래픽을 보내지 않고, 정상적인 대상에게만 트래픽을 보냅니다.
-	예: HTTP 응답 상태 코드가 200인지 확인하여 대상이 정상인지 판단.

### 대상그룹 
트래픽을 분산할 대상(예: EC2 인스턴스, 컨테이너, Lambda 함수 등)을 정의하는 논리적 단위

1. 대상(Targets):

-	대상 그룹은 여러 개의 대상(EC2 인스턴스, IP 주소, Lambda 함수 등)을 포함합니다. ELB는 대상 그룹에 포함된 대상에게 트래픽을 분산
-	대상은 **특정 포트를 통해 트래픽을 수신**합니다. 대상 그룹에서 각 대상의 상태를 모니터링하고, 헬스 체크를 기반으로 트래픽을 보내는 대상을 결정합니다.

1. 리스너와의 연결(Listener Association):

-	ELB의 **리스너(Listener)는 수신하는 트래픽을 적절한 대상 그룹으로 전달**합니다. 리스너는 포트 및 프로토콜을 지정하고, 트래픽을 처리할 대상을 결정합니다.
-	예를 들어 HTTP 리스너는 HTTP 트래픽을 대상 그룹에 전달합니다.

3. 헬스 체크(Health Check):

-	ELB는 **대상 그룹 내 각 대상을 정기적으로 확인하여 정상 상태인지 모니터링**합니다.
-	헬스 체크는 HTTP, TCP 등으로 설정할 수 있으며, 이 헬스 체크를 통과하지 못한 대상은 트래픽을 받지 않도록 설정할 수 있습니다.

4. 고정 타겟 그룹 방식:

-	**특정 대상에 트래픽을 고정시키는 고정 세션(Sticky Session) 기능을 활성화**하여, 동일한 클라이언트가 동일한 대상에 지속적으로 연결되도록 할 수 있습니다.

5. 대상 그룹 종류:

-	EC2 대상 그룹: **EC2 인스턴스**가 대상으로 등록됩니다. 주로 HTTP, HTTPS 또는 TCP 트래픽을 처리합니다.
-	IP 기반 대상 그룹: EC2 인스턴스가 아닌 **IP 주소**를 직접 대상으로 등록할 수 있습니다.
-	Lambda 대상 그룹: 서버리스 환경에서 **Lambda 함수**에 트래픽을 보낼 수 있습니다.

6. 대상 그룹 설정:

-	프로토콜 및 포트: 대상 그룹은 HTTP, HTTPS, TCP 등의 **프로토콜과 특정 포트**를 설정할 수 있습니다.
-	로드 밸런싱 알고리즘: 기본적으로 **라운드 로빈(Round Robin) 방식**으로 트래픽을 분산하지만, 다른 알고리즘도 사용할 수 있습니다.